<!doctype html>
<html>

<head>
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css">
	<script src="http://code.jquery.com/jquery-1.8.3.js"></script>
	<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
	<script src="https://raw.github.com/furf/jquery-ui-touch-punch/master/jquery.ui.touch-punch.min.js"></script>
	<script src="/ejs.js" type="text/javascript"></script>
	<script src="/jquery.cookie.js" type="text/javascript"></script>
	<script src="/socket.io/socket.io.js"></script>
	<style type="text/css">
		.chatwindow {
			padding-bottom: 50px;
			overflow: hidden;
			position: absolute;
		}
		.chatwindow .chatwindow-msgtable-container {
			overflow: auto;
			height: 100%;
		}
		.chatwindow .chatwindow-msgtable {
			max-width:100%;
			max-height:100%;
		}
		.chatwindow .chatwindow-img-container {
			overflow: auto;
			position: absolute;
			left: 0;
			right: 0;
			top: 25px;
			bottom: 0;
		}
		.chatwindow .chatwindow-img {
			max-width:100%;
			max-height:100%;
			display: block;
			height: auto;
			margin: auto;
			position: absolute;
			bottom: 0;
			top: 0;
			right: 0;
			left: 0;
		}
		.chatwindow .nicklisttable {
			height: 100%;
		}
		.chatwindow input {
			position: absolute;
			left: 0;
			right: 13px;
		}
		.timestamp, .nick {
			vertical-align: top;
			/* hint to keep the columns small */
			width: 1px;
			white-space: nowrap;
			padding-right: 1em;
		}
		.nick {
			text-align: right;
		}
		.message {
			word-break: break-all;
		}
		.nicklistcontainer {
			/* hint to keep the columns small */
			width: 1px;
			vertical-align: top;
		}
		.nicklistcontainer ul {
			display: inline;
			padding: 0;
			margin: 0;
		}
		.nicklistcontainer ul li {
			list-style-type: none;
		}
		.nicklistcontainer ul li:hover {
			cursor: pointer;
		}
		.initially-hidden {
			display:none;
		}
		/*theme1*/
		* {
			font-family: "Lucida Console", "Lucida Sans Typewriter", Monaco, "Bitstream Vera Sans Mono", monospace;
			font-size: small;
		}
		body {
			margin: 0;
			background: url('http://fc07.deviantart.net/fs71/i/2012/338/3/2/seamless_wood_tex_by_koncaliev-d5n0ph4.png');
			/*background: -webkit-gradient(linear, left top, left bottom, from(#526069), to(#718693)) fixed;*/
		}
		#tint {
			position: fixed;
			left: 0;
			right: 0;
			top: 0;
			bottom: 0;
			background-color: rgba(0,0,0,.5);
		}
		.chatwindow {
			color: #32414d;
			background-color: #e9e9e9;
			border-top-left-radius:1em;
			border-top-right-radius:1em;
			border-bottom-left-radius:0;
			border-bottom-right-radius:0;
			box-shadow: 2px 2px 15px 1px rgba(0, 0, 0, .5);
		}
		.nicklistcontainer ul li:hover {
			color: white;
			background: black;
		}
		.chatwindow-title {
			position: relative;
			left: 0;
			right: 0;
			text-align: center;
			font-size: medium;
			padding: 0.25em;
			text-shadow: 1px 1px 1px #fff;
			border-bottom: 1px solid gray;
			background: #c9c9c9;
			border-top-left-radius:1em;
			border-top-right-radius:1em;
		}
		.greentext {
			color: #789922;
		}
	</style>
</head>

<script>
	function storePositionSize(dialog) {
		var base = 'bobchat-layout';
		var id = dialog.attr('id');
		var prefix = base + '-' + id + '-';
		var defaultExpire = 365;
		$.cookie(prefix + 'pos-top', dialog.css('top'), { expires: defaultExpire });
		$.cookie(prefix + 'pos-left', dialog.css('left'), { expires: defaultExpire });
		$.cookie(prefix + 'size-width', dialog.width(), { expires: defaultExpire });
		$.cookie(prefix + 'size-height', dialog.height(), { expires: defaultExpire });
	}
	
	function restorePositionSize(dialog) {
		var base = 'bobchat-layout';
		var id = dialog.attr('id');
		var prefix = base + '-' + id + '-';
		
		var geometrics = {
			postop: $.cookie(prefix + 'pos-top'),
			posleft: $.cookie(prefix + 'pos-left'),
			sizewidth: $.cookie(prefix + 'size-width'),
			sizeheight: $.cookie(prefix + 'size-height'),
		};
		
		if (geometrics.postop == null) {
			geometrics = {
				postop: 10,
				posleft: 10,
				sizewidth: 640,
				sizeheight: 320,
			};
		}
		
		dialog.css('top', geometrics.postop);
		dialog.css('left', geometrics.posleft);
		dialog.width(geometrics.sizewidth);
		dialog.height(geometrics.sizeheight);
	}
	
	function createChatWindow(id, name, socket) {
		var dialog = $('<div id="'+id+'" class="chatwindow">'+
			'<div style="height: 100%;">'+
				'<div class="chatwindow-title">'+name+'</div>'+
				'<table class="nicklisttable">'+
					'<tr>'+
						'<td style="width: 100%;">'+
							'<div class="chatwindow-msgtable-container">'+
								'<table class="chatwindow-msgtable"/>'+
							'</div>'+
						'</td>'+
						'<td class="nicklistcontainer">'+
							'<ul class="nicklist"/>'+
						'</td>' +
					'</tr>'+
				'</table>'+
				'<input/>'+
			'</div>'+
		'</div>');

		var sendText = function() {
			var message = dialog.find('input').val();
			socket.emit('sendmessage', { to: name, message: message });
			dialog.find('input').val('');
		};
		
		dialog.find('button').click(function(){
			sendText();
		});
		
		 dialog.find('input').keyup(function(event) {
			if (event.keyCode==13) {
				sendText();
			}
		});
		
		$('#tint').append(dialog);
		
		dialog.draggable({handle: '.chatwindow-title',
			stop: function(event, ui){
				storePositionSize(dialog);
			}
		});
		dialog.resizable({stop: function(event, ui){
			storePositionSize(dialog);
		}});
		
		restorePositionSize(dialog);
		
		return dialog;
	};
	
	function createPreviewWindow(id, name, socket) {
		var dialog = $('<div id="'+id+'" class="chatwindow">'+
			'<div style="position: absolute;top: 0;bottom: 0;left: 0;right: 0;">'+
				'<div class="chatwindow-title">'+
					name+
				'</div>'+
				'<div class="chatwindow-img-container">'+
					'<img class="chatwindow-img"/>'+
				'</div>'+
			'</div>'+
		'</div>');
		
		$('#tint').append(dialog);
		dialog.draggable({handle: ".chatwindow-title",
			stop: function(event, ui){
				storePositionSize(dialog);
			}
		});
		dialog.resizable({stop: function(event, ui){
			storePositionSize(dialog);
		}});
		
		restorePositionSize(dialog);
		
		return dialog;
	};
	
	function scrollDown(dialog) {
		var container = dialog.find('.chatwindow-msgtable-container');
		container.scrollTop(container[0].scrollHeight);
		
		//container.animate({scrollTop: container.prop("scrollHeight")}, 500);
	}
	
	function previewLink(link) {
		if (link.match(new RegExp('(jpe?g)|(png)|(gif)$', 'i'))) {
			$('#preview img').attr('src', link);
		}
	}
	
	function renderMessage(message) {
		if (message && message != null) {
			// clickable links
			var urlPattern = new RegExp('\\b(https?://[^\\s]+)', 'g');
			var linkMatches = message.match(urlPattern);
			for (var i = 0; i < (linkMatches != null ? linkMatches.length : 0); ++i) {
				var link = linkMatches[i];
				previewLink(link);
			}
			
			message = message.replace( urlPattern, '<a href="$1" target="_blank">$1</a>' );
			
			// greentext
			if (message.indexOf(">") == 0 && message.indexOf(">>") != 0) {
				message = '<span class="greentext">' + message + '</span>';
			}
		}
		return message;
	}
	
	var nick = '';
	var dialogs = {};
	
	function getDialog(name, socket) {
		var dialog = dialogs[name];
		if (!dialog) {
			dialog = createChatWindow('irc.iz-smart.net#' + name, name, socket);
			dialogs[name] = dialog;
		}
		return dialog;
	}

	$(document).ready(function() {
		var socket = io.connect('http://' + location.host);
		
		createPreviewWindow('preview', 'Preview', socket);

		socket.on('registered', function (data) {
			nick = data.nick;
		});

		socket.on('message#', function (data) {
			var dialog = getDialog(data.channel, socket);
			var template = new EJS({text: '<tr><td class="timestamp"><%= timestamp %></td><td class="nick"><%= nick %></td><td class="message"><%= message %></td></tr>'});
			data.message = renderMessage(data.message);
			dialog.find('.chatwindow-msgtable').append(template.render(data));			
			scrollDown(dialog);
		});
		
		socket.on('pm', function (data) {
			var dialog = getDialog(data.target, socket);
			var template = new EJS({text: '<tr><td class="timestamp"><%= timestamp %></td><td class="nick"><%= nick %></td><td class="message"><%= message %></td></tr>'});
			data.message = renderMessage(data.message);
			dialog.find('.chatwindow-msgtable').append(template.render(data));
			scrollDown(dialog);
		});
		
		socket.on('notice', function (data) {
			var dialog = getDialog(data.channel, socket);
			var template = new EJS({text: '<tr><td class="timestamp"><%= timestamp %></td><td class="nick">/<%= nick %>/</td><td class="message"><%= message %></td></tr>'});
			data.message = renderMessage(data.message);
			dialog.find('.chatwindow-msgtable').append(template.render(data));
			scrollDown(dialog);
		});
		
		// TODO show private notices as nag bubble
		socket.on('notice-pm', function (data) {
			/*
			var dialog = getDialog(data.nick, socket);
			var template = new EJS({text: '<tr><td class="timestamp"><%= timestamp %></td><td class="nick">/<%= nick %>/</td><td class="message"><%= message %></td></tr>'});
			dialog.find('.chatwindow-msgtable').append(template.render(data));
			scrollDown(dialog);
			*/
		});

		socket.on('nick', function (data) {
			for(var i = 0; i < data.channels.length; i++) {
				var channel = data.channels[i];
				var dialog = getDialog(channel, socket);
				var template = new EJS({text: '<tr><td class="timestamp"><%= timestamp %></td><td class="nick">*</td><td class="message"><%= oldnick %> is now known as <%= newnick %></td></tr>'});
				dialog.find('.chatwindow-msgtable').append(template.render(data));
				scrollDown(dialog);
			}
		});
		
		socket.on('join', function (data) {
			var dialog = getDialog(data.channel, socket);
			var template = new EJS({text: '<tr><td class="timestamp"><%= timestamp %></td><td class="nick">*</td><td class="message"><%= nick %> joined <%= channel %></td></tr>'});
			dialog.find('.chatwindow-msgtable').append(template.render(data));
			scrollDown(dialog);
		});
		
		socket.on('part', function (data) {
			var dialog = getDialog(data.channel, socket);
			var template = new EJS({text: '<tr><td class="timestamp"><%= timestamp %></td><td class="nick">*</td><td class="message"><%= nick %> parted <%= channel %></td></tr>'});
			dialog.find('.chatwindow-msgtable').append(template.render(data));
			scrollDown(dialog);
		});
		
		socket.on('quit', function (data) {
			for(var i = 0; i < data.channels.length; i++) {
				var channel = data.channels[i];
				var dialog = dialogs[channel];
				var template = new EJS({text: '<tr><td class="timestamp"><%= timestamp %></td><td class="nick">*</td><td class="message"><%= nick %> has quit (<%= reason %>)</td></tr>'});
				dialog.find('.chatwindow-msgtable').append(template.render(data));
				scrollDown(dialog);
			}
		});
		
		socket.on('names', function (data) {
		    var dialog = getDialog(data.channel, socket);
			var template = new EJS({text: '<ul><% for (var key in nicks) { %><li class="nicklistitem"><%= nicks[key] + key %></li><% } %></ul>'});
			dialog.find('.nicklistcontainer ul').replaceWith(template.render(data));
		});
		
		socket.on('showdebugcontrols', function (data) {
			$('.initially-hidden').css('display', 'inherit')
		});
		
		var mockButton = $('<button class="initially-hidden">emit mock messages</button>');
		$('#tint').append(mockButton);
		mockButton.click(function() {
			socket.emit('mock', { });
		});
	});
</script>

<body>
<div id="tint"/>
</body>

</html>
